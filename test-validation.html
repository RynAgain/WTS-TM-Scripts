<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WTS Tampermonkey Script Validation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-warn {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .test-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .run-test-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .run-test-btn:hover {
            background-color: #0056b3;
        }
        .run-test-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .console-output {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .summary {
            background-color: #f8f9fa;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .summary h2 {
            color: #007bff;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ WTS Tampermonkey Script Validation Test Suite</h1>
        <p>This test suite validates the fixes implemented to resolve initialization errors in the WTS modular system.</p>
        
        <div class="test-section">
            <h3>üéØ Test Controls</h3>
            <button class="run-test-btn" onclick="runAllTests()">Run All Tests</button>
            <button class="run-test-btn" onclick="runModuleLoadingTest()">Test Module Loading</button>
            <button class="run-test-btn" onclick="runNamespaceTest()">Test Namespace Resolution</button>
            <button class="run-test-btn" onclick="runRegistrationTest()">Test Module Registration</button>
            <button class="run-test-btn" onclick="runDependencyTest()">Test Dependency Injection</button>
            <button class="run-test-btn" onclick="runErrorHandlingTest()">Test Error Handling</button>
            <button class="run-test-btn" onclick="runStorageTest()">Test Storage System</button>
            <button class="run-test-btn" onclick="clearResults()">Clear Results</button>
        </div>

        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <h3>üñ•Ô∏è Console Output</h3>
            <div id="console-output" class="console-output"></div>
        </div>

        <div id="summary" class="summary" style="display: none;">
            <h2>üìã Validation Summary</h2>
            <div id="summary-content"></div>
        </div>
    </div>

    <script>
        // Global test state
        let testResults = [];
        let consoleOutput = [];
        
        // Mock GM functions for testing
        if (typeof GM_setValue === 'undefined') {
            window.GM_setValue = function(key, value) {
                localStorage.setItem(key, value);
            };
            window.GM_getValue = function(key, defaultValue) {
                return localStorage.getItem(key) || defaultValue;
            };
            window.GM_deleteValue = function(key) {
                localStorage.removeItem(key);
            };
        }

        // Capture console output
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error,
            debug: console.debug
        };

        function captureConsole() {
            ['log', 'warn', 'error', 'debug'].forEach(method => {
                console[method] = function(...args) {
                    const timestamp = new Date().toISOString();
                    const message = args.map(arg => 
                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                    ).join(' ');
                    consoleOutput.push(`[${timestamp}] [${method.toUpperCase()}] ${message}`);
                    updateConsoleDisplay();
                    originalConsole[method].apply(console, args);
                };
            });
        }

        function restoreConsole() {
            Object.keys(originalConsole).forEach(method => {
                console[method] = originalConsole[method];
            });
        }

        function updateConsoleDisplay() {
            const consoleDiv = document.getElementById('console-output');
            consoleDiv.textContent = consoleOutput.slice(-50).join('\n'); // Show last 50 lines
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function addTestResult(testName, status, message, details = null) {
            const result = {
                testName,
                status, // 'pass', 'fail', 'warn', 'info'
                message,
                details,
                timestamp: new Date().toISOString()
            };
            testResults.push(result);
            updateTestDisplay();
        }

        function updateTestDisplay() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = testResults.map(result => {
                const detailsHtml = result.details ? 
                    `<div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">${result.details}</div>` : '';
                return `
                    <div class="test-result test-${result.status}">
                        <strong>${result.testName}:</strong> ${result.message}
                        ${detailsHtml}
                    </div>
                `;
            }).join('');
        }

        function clearResults() {
            testResults = [];
            consoleOutput = [];
            updateTestDisplay();
            updateConsoleDisplay();
            document.getElementById('summary').style.display = 'none';
        }

        // ==================== TEST IMPLEMENTATIONS ====================

        async function runModuleLoadingTest() {
            addTestResult('Module Loading Test', 'info', 'Starting module availability validation...');
            
            const requiredModules = [
                { name: 'WTS_Core', altName: 'WTSCore' },
                { name: 'WTS_CSRFManager' },
                { name: 'WTS_DataExtractor' },
                { name: 'WTS_ExportManager' },
                { name: 'WTS_StoreManager' },
                { name: 'WTS_UIManager' }
            ];

            let availableCount = 0;
            let missingModules = [];

            for (const moduleInfo of requiredModules) {
                const moduleName = moduleInfo.name;
                const altName = moduleInfo.altName;
                
                let moduleFound = false;
                let actualModule = null;
                
                if (typeof window[moduleName] !== 'undefined') {
                    actualModule = window[moduleName];
                    moduleFound = true;
                } else if (altName && typeof window[altName] !== 'undefined') {
                    actualModule = window[altName];
                    moduleFound = true;
                    addTestResult('Namespace Compatibility', 'info', 
                        `Found ${moduleName} as ${altName}`, 
                        'Alternative namespace resolution working');
                }
                
                if (moduleFound && actualModule !== null && typeof actualModule !== 'undefined') {
                    if (typeof actualModule === 'function' || typeof actualModule === 'object') {
                        availableCount++;
                        addTestResult('Module Available', 'pass', 
                            `${moduleName} loaded successfully`, 
                            `Type: ${typeof actualModule}`);
                    } else {
                        missingModules.push(`${moduleName} (invalid type: ${typeof actualModule})`);
                        addTestResult('Module Invalid', 'fail', 
                            `${moduleName} has invalid type: ${typeof actualModule}`);
                    }
                } else {
                    missingModules.push(moduleName);
                    addTestResult('Module Missing', 'fail', `${moduleName} not found`);
                }
            }

            if (availableCount === requiredModules.length) {
                addTestResult('Module Loading', 'pass', 
                    `All ${requiredModules.length} modules loaded successfully`);
            } else {
                addTestResult('Module Loading', 'fail', 
                    `Only ${availableCount}/${requiredModules.length} modules loaded`, 
                    `Missing: ${missingModules.join(', ')}`);
            }
        }

        async function runNamespaceTest() {
            addTestResult('Namespace Test', 'info', 'Testing WTSCore vs WTS_Core compatibility...');
            
            // Test if both namespaces exist and are compatible
            const hasWTSCore = typeof window.WTSCore !== 'undefined';
            const hasWTS_Core = typeof window.WTS_Core !== 'undefined';
            
            if (hasWTSCore && hasWTS_Core) {
                addTestResult('Namespace Compatibility', 'pass', 
                    'Both WTSCore and WTS_Core namespaces available');
                
                // Test if they're compatible
                if (window.WTSCore && window.WTSCore.constructor === window.WTS_Core) {
                    addTestResult('Namespace Compatibility', 'pass', 
                        'WTSCore instance uses WTS_Core constructor');
                } else if (typeof window.WTSCore === 'object' && typeof window.WTS_Core === 'function') {
                    addTestResult('Namespace Compatibility', 'pass', 
                        'WTSCore is instance, WTS_Core is class - compatible pattern');
                } else {
                    addTestResult('Namespace Compatibility', 'warn', 
                        'Namespace relationship unclear but both exist');
                }
            } else if (hasWTSCore) {
                addTestResult('Namespace Compatibility', 'warn', 
                    'Only WTSCore namespace available');
            } else if (hasWTS_Core) {
                addTestResult('Namespace Compatibility', 'warn', 
                    'Only WTS_Core namespace available');
            } else {
                addTestResult('Namespace Compatibility', 'fail', 
                    'Neither WTSCore nor WTS_Core namespace available');
            }
        }

        async function runRegistrationTest() {
            addTestResult('Registration Test', 'info', 'Testing module registration system...');
            
            // Try to get core instance
            let core = null;
            if (window.WTSCore && typeof window.WTSCore === 'object') {
                core = window.WTSCore;
            } else if (window.WTS_Core && typeof window.WTS_Core === 'function') {
                core = new window.WTS_Core();
            }
            
            if (!core) {
                addTestResult('Registration Test', 'fail', 'Cannot obtain core instance for testing');
                return;
            }
            
            // Test if core has module registration capabilities
            if (typeof core.registerModule === 'function') {
                addTestResult('Registration System', 'pass', 'Core has registerModule method');
            } else {
                addTestResult('Registration System', 'fail', 'Core missing registerModule method');
            }
            
            if (typeof core.getModule === 'function') {
                addTestResult('Registration System', 'pass', 'Core has getModule method');
            } else {
                addTestResult('Registration System', 'fail', 'Core missing getModule method');
            }
            
            if (core.modules && core.modules instanceof Map) {
                addTestResult('Registration System', 'pass', 'Core has modules Map');
                addTestResult('Registration System', 'info', 
                    `Modules Map contains ${core.modules.size} entries`);
            } else {
                addTestResult('Registration System', 'fail', 'Core missing modules Map');
            }
            
            // Test if moduleInstances exists (compatibility layer)
            if (core.moduleInstances && typeof core.moduleInstances === 'object') {
                addTestResult('Registration System', 'pass', 'Core has moduleInstances compatibility layer');
                addTestResult('Registration System', 'info', 
                    `moduleInstances contains ${Object.keys(core.moduleInstances).length} entries`);
            } else {
                addTestResult('Registration System', 'warn', 'Core missing moduleInstances compatibility layer');
            }
        }

        async function runDependencyTest() {
            addTestResult('Dependency Test', 'info', 'Testing dependency injection between modules...');
            
            // Get core instance
            let core = null;
            if (window.WTSCore && typeof window.WTSCore === 'object') {
                core = window.WTSCore;
            } else if (window.WTS_Core && typeof window.WTS_Core === 'function') {
                core = new window.WTS_Core();
            }
            
            if (!core) {
                addTestResult('Dependency Test', 'fail', 'Cannot obtain core instance for testing');
                return;
            }
            
            // Test if modules can access each other through core
            const testModules = ['WTS_CSRFManager', 'WTS_StoreManager', 'WTS_UIManager'];
            
            for (const moduleName of testModules) {
                if (core.moduleInstances && core.moduleInstances[moduleName]) {
                    addTestResult('Dependency Injection', 'pass', 
                        `${moduleName} available via moduleInstances`);
                } else if (core.modules && core.modules.has(moduleName)) {
                    addTestResult('Dependency Injection', 'pass', 
                        `${moduleName} available via modules Map`);
                } else {
                    addTestResult('Dependency Injection', 'warn', 
                        `${moduleName} not found in dependency system`);
                }
            }
            
            // Test UI Manager -> Store Manager dependency specifically
            if (core.moduleInstances && core.moduleInstances['WTS_UIManager'] && core.moduleInstances['WTS_StoreManager']) {
                const uiManager = core.moduleInstances['WTS_UIManager'];
                if (uiManager.modules && uiManager.modules.storeManager) {
                    addTestResult('Critical Dependency', 'pass', 
                        'UI Manager can access Store Manager');
                } else {
                    addTestResult('Critical Dependency', 'fail', 
                        'UI Manager cannot access Store Manager');
                }
            } else {
                addTestResult('Critical Dependency', 'warn', 
                    'Cannot test UI Manager -> Store Manager dependency (modules not initialized)');
            }
        }

        async function runErrorHandlingTest() {
            addTestResult('Error Handling Test', 'info', 'Testing error handling and retry logic...');
            
            // Test if core has error handling methods
            let core = null;
            if (window.WTSCore && typeof window.WTSCore === 'object') {
                core = window.WTSCore;
            } else if (window.WTS_Core && typeof window.WTS_Core === 'function') {
                core = new window.WTS_Core();
            }
            
            if (!core) {
                addTestResult('Error Handling Test', 'fail', 'Cannot obtain core instance for testing');
                return;
            }
            
            // Test error handling methods
            if (typeof core.handleError === 'function') {
                addTestResult('Error Handling', 'pass', 'Core has handleError method');
            } else {
                addTestResult('Error Handling', 'fail', 'Core missing handleError method');
            }
            
            if (typeof core.safeAsync === 'function') {
                addTestResult('Error Handling', 'pass', 'Core has safeAsync wrapper method');
            } else {
                addTestResult('Error Handling', 'warn', 'Core missing safeAsync wrapper method');
            }
            
            // Test event system for error reporting
            if (typeof core.emit === 'function' && typeof core.on === 'function') {
                addTestResult('Error Handling', 'pass', 'Core has event system for error reporting');
                
                // Test error event emission
                let errorEventReceived = false;
                const testListener = core.on('core:error', () => {
                    errorEventReceived = true;
                });
                
                // Emit test error
                core.emit('core:error', { test: true });
                
                if (errorEventReceived) {
                    addTestResult('Error Handling', 'pass', 'Error event system working');
                } else {
                    addTestResult('Error Handling', 'fail', 'Error event system not working');
                }
                
                // Clean up
                core.off('core:error', testListener);
            } else {
                addTestResult('Error Handling', 'fail', 'Core missing event system');
            }
        }

        async function runStorageTest() {
            addTestResult('Storage Test', 'info', 'Testing storage system functionality...');
            
            // Get core instance
            let core = null;
            if (window.WTSCore && typeof window.WTSCore === 'object') {
                core = window.WTSCore;
            } else if (window.WTS_Core && typeof window.WTS_Core === 'function') {
                core = new window.WTS_Core();
            }
            
            if (!core) {
                addTestResult('Storage Test', 'fail', 'Cannot obtain core instance for testing');
                return;
            }
            
            // Test storage methods
            const storageMethods = ['setValue', 'getValue', 'deleteValue', 'listKeys', 'clearStorage'];
            for (const method of storageMethods) {
                if (typeof core[method] === 'function') {
                    addTestResult('Storage System', 'pass', `Core has ${method} method`);
                } else {
                    addTestResult('Storage System', 'fail', `Core missing ${method} method`);
                }
            }
            
            // Test convenience methods
            if (core.storage) {
                const convenienceMethods = ['get', 'set', 'delete', 'clear', 'keys'];
                for (const method of convenienceMethods) {
                    if (typeof core.storage[method] === 'function') {
                        addTestResult('Storage Convenience', 'pass', `Storage has ${method} convenience method`);
                    } else {
                        addTestResult('Storage Convenience', 'fail', `Storage missing ${method} convenience method`);
                    }
                }
            } else {
                addTestResult('Storage Convenience', 'fail', 'Core missing storage convenience object');
            }
            
            // Test actual storage operations
            try {
                const testKey = 'wts_test_key';
                const testValue = { test: true, timestamp: Date.now() };
                
                // Test set
                const setResult = await core.setValue(testKey, testValue);
                if (setResult) {
                    addTestResult('Storage Operations', 'pass', 'Storage set operation successful');
                } else {
                    addTestResult('Storage Operations', 'fail', 'Storage set operation failed');
                }
                
                // Test get
                const getValue = await core.getValue(testKey);
                if (getValue && getValue.test === true) {
                    addTestResult('Storage Operations', 'pass', 'Storage get operation successful');
                } else {
                    addTestResult('Storage Operations', 'fail', 'Storage get operation failed');
                }
                
                // Test delete
                const deleteResult = await core.deleteValue(testKey);
                if (deleteResult) {
                    addTestResult('Storage Operations', 'pass', 'Storage delete operation successful');
                } else {
                    addTestResult('Storage Operations', 'fail', 'Storage delete operation failed');
                }
                
                // Verify deletion
                const deletedValue = await core.getValue(testKey, 'not_found');
                if (deletedValue === 'not_found') {
                    addTestResult('Storage Operations', 'pass', 'Storage deletion verified');
                } else {
                    addTestResult('Storage Operations', 'fail', 'Storage deletion not verified');
                }
                
            } catch (error) {
                addTestResult('Storage Operations', 'fail', `Storage operations failed: ${error.message}`);
            }
        }

        async function runAllTests() {
            addTestResult('Test Suite', 'info', 'Starting comprehensive validation test suite...');
            captureConsole();
            
            try {
                await runModuleLoadingTest();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await runNamespaceTest();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await runRegistrationTest();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await runDependencyTest();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await runErrorHandlingTest();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await runStorageTest();
                
                generateSummary();
                
            } catch (error) {
                addTestResult('Test Suite', 'fail', `Test suite failed: ${error.message}`);
            } finally {
                restoreConsole();
            }
        }

        function generateSummary() {
            const summary = testResults.reduce((acc, result) => {
                acc[result.status] = (acc[result.status] || 0) + 1;
                return acc;
            }, {});
            
            const total = testResults.length;
            const passed = summary.pass || 0;
            const failed = summary.fail || 0;
            const warnings = summary.warn || 0;
            const info = summary.info || 0;
            
            const summaryHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: #d4edda; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #155724;">${passed}</div>
                        <div style="color: #155724;">Tests Passed</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8d7da; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #721c24;">${failed}</div>
                        <div style="color: #721c24;">Tests Failed</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #856404;">${warnings}</div>
                        <div style="color: #856404;">Warnings</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #d1ecf1; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #0c5460;">${info}</div>
                        <div style="color: #0c5460;">Info Messages</div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff;">
                    <h4 style="margin-top: 0;">Overall Assessment:</h4>
                    <p><strong>Total Tests:</strong> ${total}</p>
                    <p><strong>Success Rate:</strong> ${((passed / total) * 100).toFixed(1)}%</p>
                    <p><strong>Status:</strong> ${failed === 0 ? '‚úÖ All critical tests passed' : '‚ùå Some tests failed - review required'}</p>
                </div>
            `;
            
            document.getElementById('summary-content').innerHTML = summaryHtml;
            document.getElementById('summary').style.display = 'block';
            
            addTestResult('Test Suite', 'info', `Validation complete: ${passed} passed, ${failed} failed, ${warnings} warnings`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('Test Suite', 'info', 'WTS Validation Test Suite loaded and ready');
            addTestResult('Environment', 'info', `User Agent: ${navigator.userAgent}`);
            addTestResult('Environment', 'info', `GM Functions Available: ${typeof GM_setValue !== 'undefined'}`);
        });
    </script>
</body>
</html>