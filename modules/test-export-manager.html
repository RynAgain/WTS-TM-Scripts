<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WTS Export Manager Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-warning {
            background-color: #ffc107;
            color: black;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .log-container {
            background-color: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .data-preview {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
        .format-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ WTS Export Manager Test Suite</h1>
        <p>This page tests the WTS Export Manager module functionality including CSV, JSON, and TSV export capabilities.</p>
        
        <div id="initialization-status" class="status info">
            <strong>Status:</strong> Initializing modules...
        </div>
    </div>

    <div class="container">
        <h2>ðŸ“Š Module Statistics</h2>
        <div class="stats-grid" id="stats-grid">
            <!-- Stats will be populated here -->
        </div>
        <button class="btn-primary" onclick="updateStats()">Refresh Statistics</button>
    </div>

    <div class="container">
        <h2>ðŸ§ª Export Tests</h2>
        
        <div class="test-section">
            <h3>Sample Data Generation</h3>
            <div class="test-controls">
                <button class="btn-success" onclick="generateSampleData(5)">Generate 5 Items</button>
                <button class="btn-success" onclick="generateSampleData(25)">Generate 25 Items</button>
                <button class="btn-success" onclick="generateSampleData(100)">Generate 100 Items</button>
                <button class="btn-warning" onclick="generateEmptyData()">Generate Empty Data</button>
                <button class="btn-danger" onclick="clearSampleData()">Clear Data</button>
            </div>
            <div class="data-preview" id="sample-data-preview">
                No sample data generated yet.
            </div>
        </div>

        <div class="test-section">
            <h3>Export Functionality</h3>
            <div class="format-selector">
                <label for="export-format">Export Format:</label>
                <select id="export-format">
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                    <option value="tsv">TSV</option>
                </select>
                
                <label for="custom-filename">Custom Filename:</label>
                <input type="text" id="custom-filename" placeholder="Optional custom filename">
                
                <label>
                    <input type="checkbox" id="include-timestamp" checked> Include Timestamp
                </label>
            </div>
            
            <div class="test-controls">
                <button class="btn-primary" onclick="testExport()">Export Sample Data</button>
                <button class="btn-primary" onclick="testLegacyCSV()">Test Legacy CSV Export</button>
                <button class="btn-warning" onclick="testExportWithOptions()">Export with Custom Options</button>
                <button class="btn-danger" onclick="testInvalidExport()">Test Invalid Data Export</button>
            </div>
        </div>

        <div class="test-section">
            <h3>Configuration Tests</h3>
            <div class="test-controls">
                <button class="btn-primary" onclick="testConfigurationUpdate()">Update Configuration</button>
                <button class="btn-primary" onclick="testGetSupportedFormats()">Get Supported Formats</button>
                <button class="btn-warning" onclick="testExportHistory()">View Export History</button>
                <button class="btn-danger" onclick="testClearHistory()">Clear Export History</button>
            </div>
        </div>

        <div class="test-section">
            <h3>Event System Tests</h3>
            <div class="test-controls">
                <button class="btn-primary" onclick="testEventEmission()">Test Event Emission</button>
                <button class="btn-primary" onclick="testDataReceived()">Simulate Data Received</button>
                <button class="btn-warning" onclick="testExportRequest()">Test Export Request Event</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ðŸ“‹ Test Log</h2>
        <button class="btn-warning" onclick="clearLog()">Clear Log</button>
        <div class="log-container" id="log-container">
            <div>WTS Export Manager Test Suite initialized...</div>
        </div>
    </div>

    <!-- Load required modules -->
    <script src="wts-core.js"></script>
    <script src="wts-export-manager.js"></script>

    <script>
        // Global variables
        let core;
        let exportManager;
        let sampleData = [];

        // Initialize the test environment
        async function initializeTest() {
            try {
                log('Initializing WTS Core...', 'info');
                
                // Initialize WTS Core
                core = new WTS_Core();
                await core.initialize();
                
                log('Registering WTS Export Manager...', 'info');
                
                // Register Export Manager
                const registrationResult = registerExportManager(core);
                if (!registrationResult) {
                    throw new Error('Failed to register Export Manager');
                }
                
                // Initialize Export Manager
                const initResult = await core.initializeModule('WTS_ExportManager');
                if (!initResult) {
                    throw new Error('Failed to initialize Export Manager');
                }
                
                // Get module instance
                const moduleInfo = core.getModule('WTS_ExportManager');
                exportManager = moduleInfo.instance;
                
                log('WTS Export Manager initialized successfully!', 'success');
                updateInitializationStatus('success', 'All modules initialized successfully');
                
                // Setup event listeners for testing
                setupEventListeners();
                
                // Update initial statistics
                updateStats();
                
            } catch (error) {
                log(`Initialization failed: ${error.message}`, 'error');
                updateInitializationStatus('error', `Initialization failed: ${error.message}`);
            }
        }

        // Setup event listeners for testing
        function setupEventListeners() {
            core.on('export:started', (data) => {
                log(`Export started: ${JSON.stringify(data)}`, 'info');
            });
            
            core.on('export:completed', (data) => {
                log(`Export completed: ${data.filename} (${data.itemCount} items, ${data.format} format)`, 'success');
                updateStats();
            });
            
            core.on('export:failed', (data) => {
                log(`Export failed: ${data.error}`, 'error');
                updateStats();
            });
            
            core.on('module:ready', (data) => {
                log(`Module ready: ${data.name} v${data.version}`, 'info');
            });
        }

        // Update initialization status
        function updateInitializationStatus(type, message) {
            const statusElement = document.getElementById('initialization-status');
            statusElement.className = `status ${type}`;
            statusElement.innerHTML = `<strong>Status:</strong> ${message}`;
        }

        // Logging function
        function log(message, level = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            
            let color = '#00ff00';
            switch (level) {
                case 'error': color = '#ff4444'; break;
                case 'warn': color = '#ffaa00'; break;
                case 'success': color = '#44ff44'; break;
                case 'info': color = '#00aaff'; break;
            }
            
            logEntry.style.color = color;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Clear log
        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
        }

        // Generate sample data
        function generateSampleData(count) {
            sampleData = [];
            const sections = ['fresh-produce', 'dairy-eggs', 'meat-seafood', 'bakery', 'pantry-essentials'];
            const sampleNames = [
                'Organic Bananas', 'Free Range Eggs', 'Wild Salmon Fillet', 'Artisan Bread',
                'Almond Milk', 'Grass Fed Beef', 'Fresh Spinach', 'Greek Yogurt',
                'Quinoa', 'Olive Oil', 'Avocados', 'Chicken Breast', 'Blueberries'
            ];
            
            for (let i = 0; i < count; i++) {
                sampleData.push({
                    ASIN: `B${String(Math.floor(Math.random() * 1000000000)).padStart(9, '0')}`,
                    Name: sampleNames[Math.floor(Math.random() * sampleNames.length)] + ` ${i + 1}`,
                    Section: sections[Math.floor(Math.random() * sections.length)]
                });
            }
            
            updateSampleDataPreview();
            log(`Generated ${count} sample items`, 'success');
        }

        // Generate empty data
        function generateEmptyData() {
            sampleData = [];
            updateSampleDataPreview();
            log('Generated empty data set', 'info');
        }

        // Clear sample data
        function clearSampleData() {
            sampleData = [];
            updateSampleDataPreview();
            log('Sample data cleared', 'info');
        }

        // Update sample data preview
        function updateSampleDataPreview() {
            const preview = document.getElementById('sample-data-preview');
            if (sampleData.length === 0) {
                preview.textContent = 'No sample data generated yet.';
            } else {
                const previewText = `${sampleData.length} items:\n` + 
                    sampleData.slice(0, 3).map(item => 
                        `ASIN: ${item.ASIN}, Name: ${item.Name}, Section: ${item.Section}`
                    ).join('\n') +
                    (sampleData.length > 3 ? '\n... and more' : '');
                preview.textContent = previewText;
            }
        }

        // Test export functionality
        async function testExport() {
            if (!exportManager) {
                log('Export Manager not initialized', 'error');
                return;
            }
            
            if (sampleData.length === 0) {
                log('No sample data available. Generate some data first.', 'warn');
                return;
            }
            
            const format = document.getElementById('export-format').value;
            const customFilename = document.getElementById('custom-filename').value;
            const includeTimestamp = document.getElementById('include-timestamp').checked;
            
            const options = {
                format: format,
                includeTimestamp: includeTimestamp
            };
            
            if (customFilename) {
                options.customFileName = customFilename;
            }
            
            log(`Starting export test with ${sampleData.length} items in ${format} format...`, 'info');
            
            try {
                const result = await exportManager.exportData(sampleData, options);
                if (result.success) {
                    log(`Export test successful: ${result.filename}`, 'success');
                } else {
                    log(`Export test failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`Export test error: ${error.message}`, 'error');
            }
        }

        // Test legacy CSV export
        async function testLegacyCSV() {
            if (!exportManager) {
                log('Export Manager not initialized', 'error');
                return;
            }
            
            if (sampleData.length === 0) {
                log('No sample data available. Generate some data first.', 'warn');
                return;
            }
            
            log(`Testing legacy CSV export with ${sampleData.length} items...`, 'info');
            
            try {
                const result = await exportManager.downloadCSV(sampleData);
                if (result.success) {
                    log(`Legacy CSV export successful: ${result.filename}`, 'success');
                } else {
                    log(`Legacy CSV export failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`Legacy CSV export error: ${error.message}`, 'error');
            }
        }

        // Test export with custom options
        async function testExportWithOptions() {
            if (!exportManager) {
                log('Export Manager not initialized', 'error');
                return;
            }
            
            if (sampleData.length === 0) {
                log('No sample data available. Generate some data first.', 'warn');
                return;
            }
            
            const customOptions = {
                format: 'csv',
                customFileName: 'custom_export_test',
                includeTimestamp: true,
                fields: ['Name', 'ASIN'], // Custom field selection
                csvDelimiter: ';' // Custom delimiter
            };
            
            log('Testing export with custom options...', 'info');
            
            try {
                const result = await exportManager.exportData(sampleData, customOptions);
                if (result.success) {
                    log(`Custom options export successful: ${result.filename}`, 'success');
                } else {
                    log(`Custom options export failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`Custom options export error: ${error.message}`, 'error');
            }
        }

        // Test invalid export
        async function testInvalidExport() {
            if (!exportManager) {
                log('Export Manager not initialized', 'error');
                return;
            }
            
            log('Testing export with invalid data...', 'info');
            
            try {
                // Test with invalid data types
                const invalidData = [null, undefined, 'string', 123];
                const result = await exportManager.exportData(invalidData);
                log(`Invalid export result: ${result.success ? 'Unexpected success' : result.error}`, 'info');
            } catch (error) {
                log(`Invalid export error (expected): ${error.message}`, 'info');
            }
        }

        // Test configuration update
        function testConfigurationUpdate() {
            if (!exportManager) {
                log('Export Manager not initialized', 'error');
                return;
            }
            
            const newConfig = {
                defaultFormat: 'json',
                includeTimestamp: false,
                csvDelimiter: ';'
            };
            
            log('Testing configuration update...', 'info');
            
            const result = exportManager.updateConfiguration(newConfig);
            if (result) {
                log('Configuration updated successfully', 'success');
            } else {
                log('Configuration update failed', 'error');
            }
        }

        // Test get supported formats
        function testGetSupportedFormats() {
            if (!exportManager) {
                log('Export Manager not initialized', 'error');
                return;
            }
            
            const formats = exportManager.getSupportedFormats();
            log(`Supported formats: ${formats.join(', ')}`, 'info');
        }

        // Test export history
        function testExportHistory() {
            if (!exportManager) {
                log('Export Manager not initialized', 'error');
                return;
            }
            
            const history = exportManager.getExportHistory();
            log(`Export history (${history.length} entries):`, 'info');
            
            history.forEach((entry, index) => {
                const date = new Date(entry.timestamp).toLocaleString();
                log(`  ${index + 1}. ${entry.filename} (${entry.format}, ${entry.itemCount} items) - ${date}`, 'info');
            });
        }

        // Test clear history
        function testClearHistory() {
            if (!exportManager) {
                log('Export Manager not initialized', 'error');
                return;
            }
            
            const result = exportManager.clearHistory();
            if (result) {
                log('Export history cleared successfully', 'success');
                updateStats();
            } else {
                log('Failed to clear export history', 'error');
            }
        }

        // Test event emission
        function testEventEmission() {
            if (!core) {
                log('Core not initialized', 'error');
                return;
            }
            
            log('Testing event emission...', 'info');
            
            // Emit test events
            core.emit('export:test', { message: 'Test event emission' });
            core.emit('data:extracted', { data: sampleData, timestamp: Date.now() });
            
            log('Test events emitted', 'success');
        }

        // Test data received simulation
        function testDataReceived() {
            if (!core) {
                log('Core not initialized', 'error');
                return;
            }
            
            log('Simulating data received event...', 'info');
            
            const testData = {
                data: sampleData,
                timestamp: Date.now(),
                source: 'test'
            };
            
            core.emit('data:extracted', testData);
            log('Data received event simulated', 'success');
        }

        // Test export request event
        function testExportRequest() {
            if (!core) {
                log('Core not initialized', 'error');
                return;
            }
            
            if (sampleData.length === 0) {
                log('No sample data available. Generate some data first.', 'warn');
                return;
            }
            
            log('Testing export request event...', 'info');
            
            const exportRequest = {
                data: sampleData,
                options: {
                    format: 'csv',
                    customFileName: 'event_test_export'
                }
            };
            
            core.emit('export:request', exportRequest);
            log('Export request event emitted', 'success');
        }

        // Update statistics display
        function updateStats() {
            if (!exportManager) return;
            
            const stats = exportManager.getStatistics();
            const statsGrid = document.getElementById('stats-grid');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.exportCount}</div>
                    <div class="stat-label">Total Exports</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.errorCount}</div>
                    <div class="stat-label">Export Errors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.lastExportTime ? new Date(stats.lastExportTime).toLocaleString() : 'Never'}</div>
                    <div class="stat-label">Last Export</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.isExporting ? 'Yes' : 'No'}</div>
                    <div class="stat-label">Currently Exporting</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.supportedFormats.length}</div>
                    <div class="stat-label">Supported Formats</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.supportedFormats.join(', ')}</div>
                    <div class="stat-label">Available Formats</div>
                </div>
            `;
        }

        // Initialize when page loads
        window.addEventListener('load', initializeTest);
    </script>
</body>
</html>